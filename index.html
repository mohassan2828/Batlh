<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم محمد | رادار الزوار والتحميلات</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background: #0f172a; color: white; padding: 20px; margin: 0; }
        .header { text-align: center; padding: 20px; background: #1e293b; border-radius: 15px; border-bottom: 4px solid #38bdf8; margin-bottom: 20px; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: #1e293b; padding: 20px; border-radius: 15px; text-align: center; border: 1px solid #334155; }
        .card h2 { color: #38bdf8; font-size: 40px; margin: 10px 0; }
        .card.download { border-color: #22c55e; }
        .card.download h2 { color: #22c55e; }
        .table-container { background: #1e293b; border-radius: 15px; overflow-x: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 15px; text-align: right; border-bottom: 1px solid #334155; }
        th { background: #334155; color: #38bdf8; }
        tr:hover { background: #2d3a4f; }
        .badge { background: #38bdf8; color: #0f172a; padding: 3px 8px; border-radius: 5px; font-size: 12px; font-weight: bold; }
        .badge-lang { background: #22c55e; color: white; padding: 3px 8px; border-radius: 5px; font-size: 12px; }
        h3.title { margin-bottom: 10px; color: #94a3b8; border-right: 4px solid #38bdf8; padding-right: 10px; }
    </style>
</head>
<body>

<div class="header">
    <h1>رادار محمد | الإحصائيات الشاملة</h1>
</div>

<div class="stat-grid">
    <div class="card">
        <h3>إجمالي الزيارات</h3>
        <h2 id="total-count">0</h2>
    </div>
    <div class="card download">
        <h3>إجمالي التحميلات</h3>
        <h2 id="download-count">0</h2>
    </div>
</div>

<h3 class="title">سجل الزوار الأخير</h3>
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>التوقيت</th>
                <th>البلد والمدينة</th>
                <th>النظام</th>
            </tr>
        </thead>
        <tbody id="logs-list"></tbody>
    </table>
</div>

<h3 class="title">سجل تحميلات الـ CV</h3>
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>التوقيت</th>
                <th>اللغة</th>
                <th>الحالة</th>
            </tr>
        </thead>
        <tbody id="download-list"></tbody>
    </table>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBeTU1K8LyYh5ZRa9omgewSO9PP4JxFVf4",
        authDomain: "cv-stats-d2eda.firebaseapp.com",
        projectId: "cv-stats-d2eda",
        storageBucket: "cv-stats-d2eda.firebasestorage.app",
        messagingSenderId: "751477887016",
        appId: "1:751477887016:web:315202dbae3a945f02a51d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 1. مراقبة الزوار (visitor_logs)
    const qVisitors = query(collection(db, "visitor_logs"), orderBy("timestamp", "desc"));
    onSnapshot(qVisitors, (snapshot) => {
        document.getElementById('total-count').innerText = snapshot.size;
        let html = "";
        snapshot.forEach((doc) => {
            const d = doc.data();
            const time = d.timestamp ? d.timestamp.toDate().toLocaleString('ar-EG') : "...";
            html += `<tr>
                <td>${time}</td>
                <td><span class="badge">${d.country || 'Unknown'}</span> ${d.city || ''}</td>
                <td>${d.platform || '---'}</td>
            </tr>`;
        });
        document.getElementById('logs-list').innerHTML = html;
    });

    // 2. مراقبة التحميلات (download_logs)
    const qDownloads = query(collection(db, "download_logs"), orderBy("timestamp", "desc"));
    onSnapshot(qDownloads, (snapshot) => {
        document.getElementById('download-count').innerText = snapshot.size;
        let html = "";
        snapshot.forEach((doc) => {
            const d = doc.data();
            const time = d.timestamp ? d.timestamp.toDate().toLocaleString('ar-EG') : "...";
            html += `<tr>
                <td>${time}</td>
                <td><span class="badge-lang">${d.language || 'ar'}</span></td>
                <td style="color: #22c55e;">تم التحميل بنجاح ✅</td>
            </tr>`;
        });
        document.getElementById('download-list').innerHTML = html;
    });
</script>
</body>
</html>
